version: v1.0
name: Docker
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
blocks:
  - name: Build
    task:
      jobs:
        - name: docker build
          commands:
            - checkout
            - 'echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin'
            - 'echo ls '
            - 'docker build . -t "${DOCKER_USERNAME}"/prokurio-ai:latest -f ./langflow/docker/build_and_push.Dockerfile'
            - 'aws lightsail push-container-image --region central-2 --service-name prokurio-ai --label prokurio-ai --image "${DOCKER_USERNAME}"/prokurio-ai:latest'
      secrets:
        - name: AWS
        - name: Docker Hub
      prologue:
        commands:
          - 'curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"'
          - unzip awscliv2.zip
          - sudo ./aws/install --bin-dir /usr/local/bin --install-dir /usr/local/aws-cli --update
          - 'sudo curl "https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl" -o "/usr/local/bin/lightsailctl"'
          - sudo chmod +x /usr/local/bin/lightsailctl
